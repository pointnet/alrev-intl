name: alrev-intl-abstractions

on:
  push:
    tags: [ '*Alrev.Intl.Abstractions*' ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Setting payload as steps variables
        id: get-payload
        uses: actions/github-script@0.9.0
        with:
          script: |
            const matches = context.payload.ref.match(/([^/\d]+)\.(\d.+)/)
            core.setOutput('ref', context.payload.ref)
            core.setOutput('package', matches[1])
            core.setOutput('version', matches[2])
            core.setOutput('owner', context.payload.repository.owner.name)
      - uses: actions/checkout@v2
        with:
          ref: ${{steps.get-payload.outputs.ref}}
      - name: Setup .NET Core 3.1
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 3.1.x
      - name: Setup .NET 5.0
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 5.0.x
      - name: Restore dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --no-restore --configuration Release ./packages/${{steps.get-payload.outputs.package}}/${{steps.get-payload.outputs.package}}.csproj
      - name: Pack
        run: dotnet pack --no-restore --no-build --configuration Release --output ./packages ./packages/${{steps.get-payload.outputs.package}}/${{steps.get-payload.outputs.package}}.csproj
      - name: Push to nuget
        run: dotnet nuget push ./packages/${{steps.get-payload.outputs.package}}.${{steps.get-payload.outputs.version}}.nupkg --source https://api.nuget.org/v3/index.json --skip-duplicate --api-key ${{secrets.NUGET_API_KEY}} 
      - name: Push to github
        uses: tanaka-takayoshi/nuget-publish-to-github-packages-action@v2.1
        with:
         nupkg-path: ./packages/${{steps.get-payload.outputs.package}}.${{steps.get-payload.outputs.version}}.nupkg
         repo-owner: ${{steps.get-payload.outputs.owner}}
         gh-user: ${{steps.get-payload.outputs.owner}}
         token: ${{secrets.GITHUB_TOKEN}}
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{steps.get-payload.outputs.package}}.${{steps.get-payload.outputs.version}}.nupkg
          path: ./packages/${{steps.get-payload.outputs.package}}.${{steps.get-payload.outputs.version}}.nupkg 
